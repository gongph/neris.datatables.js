/**
 * 数据表格组件，使用前请阅读组件API文档。
 * 旧的分页表格组件（neris.grid.js）新功能已停止更新，使用上下分页等新功能请使用此组件。
 * 该组件依赖第三方插件 jQuery、jquery.dataTables.js、dataTables.bootstrap.js。
 *
 * Copyright ® 中国证监会中央监管信息平台版权所有
 *
 * Author: https://github.com/gongph
 * Version: 1.0.0
 * Date: 2017-04-24 10:37
 */
(function(factory){"use strict";if(typeof jQuery==="undefined"){throw new Error("neris.datatables.js required jQuery!")}typeof exports==="object"&&typeof module==="object"&&typeof module.exports==="object"?module.exports=factory():typeof define==="function"&&define.amd?define(factory):factory()})(function(){"use strict";var _tableId,_containerId,_tableObj,_allcheckCache=[],_selectedCache=[],_settings,NerisDataTables=function(options){this.each(function(){_tableId='#'+this.id;_containerId=_tableId+"_wrapper";if(!options){throw new Error("'$("+_tableId+"').nerisDataTables({...}) parameter cannot be null！")}if(options.checking&&!options.rowId){throw new Error("when the `checking` option is enabled, you must set the `rowId` option at the same time!")}_settings=$.extend(true,{},_options,options);if(_settings.indexing){_settings.columns.unshift(_fnAddIndexing())}if(_settings.checking){_settings.columns.unshift(_fnAddChecking())}if(_settings.scrollX){$(_tableId).addClass("nowrap")}_fnInitDataTables()});return{getSelected:function(){return _fnGetSelected()},setPage:function(set){return _fnSetPage(set)}}},_language={info:"当前第 _PAGE_ 页 / 共 _PAGES_ 页",infoEmpty:"当前第 0 页 / 共 0 页",lengthMenu:"每页显示  _MENU_ 条",search:"查询: ",paginate:{first:"首页",last:"末页",next:"下一页",previous:"上一页"},"processing":"加载中...","loadingRecords":"加载中...","zeroRecords":"没有符合条件的数据！",},_options={indexing:false,checking:false,language:_language,processing:false,serverSide:true,paging:true,pageLength:5,pageShow:"bottom",scrollX:false,ordering:false,rowId:"",ajax:{url:"",type:"POST"},dom:"",columns:[],};function _fnAddIndexing(){return{data:null,title:"序号",render:function(data,type,row,meta){return meta.row+1}}}function _fnAddChecking(){var _checkObj={};_checkObj.title="<input type='checkbox' class='dataTables_allcheck'/>";_checkObj.orderable=false;_checkObj.data=null;_checkObj.defaultContent="<input type='checkbox' class='dataTables_check'/>";return _checkObj}function _fnCustomerDom(){var dom='<"row"<"col-sm-7"p><"neris-page-info col-sm-5"i>>';if(_settings.pageShow==="top"){return dom+"rt"}else if(_settings.pageShow==="bottom"){return "rt"+dom}else if(_settings.pageShow==="all"){return dom+"rt"+dom}}function _fnInitDataTables(){$.fn.dataTable.ext.errMode='none';_tableObj=$(_tableId).DataTable({language:_settings.language,processing:_settings.processing,serverSide:_settings.serverSide,rowId:_settings.rowId,paging:_settings.paging,pageLength:_settings.pageLength,scrollX:_settings.scrollX,ordering:_settings.ordering,ajax:_settings.ajax,dom:_fnCustomerDom(),columns:_settings.columns,initComplete:function(settings,json){_fnAddPageInfoAndJumpBtn(this.api().page.info());if(_settings.scrollX){_fnInitCustomScrollbar()}},rowCallback:function(row,data){if(_settings.checking&&_settings.rowId){if($.inArray(data[_settings.rowId],_selectedCache[_fnGetCacheKey()])!==-1){_fnSetCheckedState(row,true)}}}});if(_settings.checking){_fnInitEvents()}}function _fnInitEvents(){$(_tableId).on("draw.dt",function(){if(_allcheckCache[_fnGetCacheKey()]){_fnSetAllcheckState(true)}else{_fnSetAllcheckState(false)}});$(_tableObj.table().body()).on("click",".dataTables_check",function(event){_fnHandleSelectedCache($(this).closest("tr")[0]);$(_tableObj.table().header()).find("input.dataTables_allcheck").trigger("listener.row.click")});$(_tableObj.table().header()).on("click","input.dataTables_allcheck",function(event){var ischecked=$(this).prop("checked"),nodes=_fnGetRowsNodesOfCurrentPage();if(ischecked){_fnHandleAllcheckCache("save");$(nodes).find("input.dataTables_check[type='checkbox']").not(":checked").each(function(index,curInput){_fnHandleSelectedCache($(curInput).closest("tr")[0]);})}else{_fnHandleAllcheckCache("del");$(nodes).find("input.dataTables_check[type='checkbox']:checked").each(function(index,curInput){_fnHandleSelectedCache($(curInput).closest("tr")[0]);})}});$(_tableObj.table().header()).on("listener.row.click","input.dataTables_allcheck",function(){if(_selectedCache[_fnGetCacheKey()].length===_fnGetRowsNodesOfCurrentPage().length){_fnSetAllcheckState(true);_fnHandleAllcheckCache("save");}else{_fnSetAllcheckState(false);_fnHandleAllcheckCache("del")}});$(_containerId).find(".neris-page-info").delegate(".btn-jump","click",function(event){var jumpInputObj=$(this).siblings(),pageNum=parseInt(jumpInputObj.val().trim()),msg="请输入有效的页码!";if(isNaN(pageNum)||!/^[1-9]\d*$/.test(pageNum)||pageNum>_tableObj.page.info().pages){jumpInputObj.focus().val("");alert(msg);return}_tableObj.page(pageNum-1).draw(false)})}function _fnGetRowsNodesOfCurrentPage(){return _tableObj.rows({page:"current"}).nodes()}function _fnHandleSelectedCache(row){var rowId=row.id,k=_fnGetCacheKey(),index;if(!_selectedCache[k]){_selectedCache[k]=[]}index=$.inArray(rowId,_selectedCache[k]);if(index===-1){_fnSetCheckedState(row,true);_selectedCache[k].push(rowId);}else{_fnSetCheckedState(row,false);_selectedCache[k].splice(index,1);}}function _fnHandleAllcheckCache(type){var k=_fnGetCacheKey();if(!_allcheckCache[k]){_allcheckCache[k]={}}if(type==="save"){_allcheckCache[k].checked=true}if(type==="del"){delete _allcheckCache[k]}}function _fnSetCheckedState(row,state){$(row).find("input.dataTables_check").prop("checked",state)}function _fnSetAllcheckState(state){$(_tableObj.table().header()).find(".dataTables_allcheck").prop("checked",state)}function _fnGetCurrentPage(){return(_tableObj.page()+1)||1}function _fnGetCacheKey(){return _fnGetCurrentPage()+"_of_page"}function _fnAddPageInfoAndJumpBtn(pageInfo){var info=[];info.push('<div class="dataTables_info">共 ',pageInfo.pages,' 页，');info.push(pageInfo.recordsTotal,' 条记录。跳转到第 ');info.push('<input type="text" class="jump-page"/> 页');info.push('<button class="btn btn-xs btn-primary btn-jump">GO</button></div>');$(_containerId).find(".neris-page-info").html(info.join(" "))}function _fnInitCustomScrollbar(){$(_containerId).find(".dataTables_scroll").mCustomScrollbar({theme:'minimal-dark',horizontalScroll:true,advanced:{updateOnSelectorChange:true},callbacks:{onScroll:function(){$(_containerId).find(".mCustomScrollBox").removeAttr("style")}}});$(_containerId).find(".dataTables_scrollBody").removeAttr("style");$(_containerId).find(".mCSB_horizontal.mCSB_inside .mCSB_container").css({marginBottom:"10px"})}function _fnCloneArray(arrs){var cloneAttrs=[];for(var i in arrs){if(!cloneAttrs[i]){cloneAttrs[i]=[]}for(var j=0,len=arrs[i].length;j<len;j+=1){cloneAttrs[i].push(arrs[i][j])}}return cloneAttrs}function _fnGetSelected(){var tempAttrs=_fnCloneArray(_selectedCache),selectedDatas=[];for(var prop in tempAttrs){if(tempAttrs.hasOwnProperty(prop)){for(var i=0,len=tempAttrs[prop].length;i<len;i+=1){selectedDatas.push(tempAttrs[prop][i])}}}return selectedDatas}function _fnGetMaxPage(){return _tableObj.page.info().pages}function _fnSetPage(set){if(!set||parseInt(set,10)<0){set=1}if(typeof set==="string"&&/^[first|last|next|previous]+$/.test(set)){_tableObj.page(set).draw(false)}else if(typeof set==="number"){var maxPage=_fnGetMaxPage();if(set>=maxPage){set=maxPage}_tableObj.page(set-1).draw(false)}}$.fn.nerisDataTables=NerisDataTables});